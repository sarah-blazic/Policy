resource "panos_vulnerability_security_profile" "this" {
  #for yaml files change jsondecode => yamldecode
  for_each = var.vulnerability_file != "optional" ? { for file in jsondecode(file(var.vulnerability_file)) : file.name => file } : tomap({})

  name         = each.key
  device_group = try(each.value.device_group, "shared")
  description  = try(each.value.description, null)

  dynamic "rule" {
    for_each = lookup(each.value, "rule", null) != null ? { for rules in each.value.rule : rules.name => rules } : tomap({})
    content {
      name         = rule.value.name
      threat_name  = lookup(rule.value, "threat_name", null )
      cves         = lookup(rule.value, "cves", null )
      host         = lookup(rule.value, "host", "any" )
      vendor_ids   = lookup(rule.value, "vendor_ids", null )
      severities   = lookup(rule.value, "severities", "any" )
      category     = lookup(rule.value, "category", "any" )
      action       = lookup(rule.value, "action", "default" )
      block_ip_track_by = lookup(rule.value, "" )
    }
  }

  dynamic "exception" {
    for_each = lookup(each.value, "exception", null) != null ? { for ex in each.value.exception : ex.name => ex } : tomap({})
    content {
      name         = ex.value.name
      applications = lookup(rule.value, "applications", ["any"])
      file_types   = lookup(rule.value, "file_types", ["any"])
      direction    = lookup(rule.value, "direction", "both")
      analysis     = lookup(rule.value, "analysis", "public-cloud")
    }
  }
}